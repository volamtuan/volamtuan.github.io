<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Gi·∫£i M√£ JavaScript</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #0b0f13;
            color: #e6eef3;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            background: #0f1720;
            border: 1px solid #1e2933;
            border-radius: 8px;
            padding: 25px;
        }
        h1 { color: #0ea5a4; text-align: center; }
        textarea, pre {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            background-color: #020617;
            border: 1px solid #334155;
            color: #e2e8f0;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .btn-primary { background-color: #0ea5a4; border-color: #0ea5a4; }
        .btn-primary:hover { background-color: #0d9494; border-color: #0d9494; }
        #log {
            margin-top: 10px;
            color: #94a3b8;
            text-align: center;
            min-height: 20px;
        }
    </style>
    <!-- Th∆∞ vi·ªán c·∫ßn thi·∫øt -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.1/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div class="text-container">
        <h1>üöÄ C√¥ng C·ª• Gi·∫£i M√£ JavaScript</h1>
       
            <textarea id="inputCode" class="form-control" rows="5" placeholder="D√°n m√£ c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
        </div>
        <br>
        <div class="d-flex gap-2">
            <button id="decodeBtn" class="btn btn-primary flex-grow-1">Gi·∫£i M√£</button>
            <button id="copyBtn" class="btn btn-success">Sao Ch√©p</button>
            <button id="clearBtn" class="btn btn-danger">X√≥a</button>
        </div>

        <hr class="my-4" style="border-color:#1e2933;">
        
        <div class="mb-3">
             <pre><code id="outputCode" class="language-javascript">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</code></pre>
        </div>
        
        <div id="log"></div>
    </div>

    <script>
        const inputEl = document.getElementById('inputCode');
        const outputEl = document.getElementById('outputCode');
        const logEl = document.getElementById('log');
        const decodeBtn = document.getElementById('decodeBtn');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');

        /**
         * H√†m depack c·ªët l√µi, s·ª≠ d·ª•ng k·ªπ thu·∫≠t "eval hijacking" ƒë·ªÉ b·∫Øt
         * ƒëo·∫°n m√£ ƒë√£ ƒë∆∞·ª£c gi·∫£i m√£ m√† kh√¥ng th·ª±c thi n√≥.
         * @param {string} packedCode - ƒêo·∫°n m√£ b·ªã m√£ h√≥a.
         * @returns {string|null} - ƒêo·∫°n m√£ ƒë√£ ƒë∆∞·ª£c gi·∫£i m√£ ho·∫∑c null n·∫øu th·∫•t b·∫°i.
         */
        function depack(packedCode) {
            if (!packedCode || !packedCode.trim().startsWith('eval')) {
                return null;
            }
            try {
                let decoded = null;
                const original_eval = window.eval;
                window.eval = (str) => { decoded = str; };
                original_eval(packedCode);
                window.eval = original_eval;
                return decoded;
            } catch (e) {
                // Kh√¥i ph·ª•c eval g·ªëc n·∫øu c√≥ l·ªói
                window.eval = window.eval_original || window.eval;
                return null;
            }
        }
        
        /**
         * Th·ª±c hi·ªán gi·∫£i m√£ li√™n t·ª•c cho ƒë·∫øn khi m√£ kh√¥ng th·ªÉ gi·∫£i m√£ th√™m.
         * @param {string} code - ƒêo·∫°n m√£ ƒë·∫ßu v√†o.
         * @returns {object} - Ch·ª©a m√£ ƒë√£ gi·∫£i m√£ v√† s·ªë l·∫ßn l·∫∑p.
         */
        function unpackContinuously(code) {
            let currentCode = code;
            let iterations = 0;
            const MAX_ITERATIONS = 15; // Gi·ªõi h·∫°n an to√†n

            while (iterations < MAX_ITERATIONS) {
                const unpacked = depack(currentCode);
                if (unpacked && unpacked !== currentCode) {
                    currentCode = unpacked;
                    iterations++;
                } else {
                    // Kh√¥ng th·ªÉ depack th√™m, d·ª´ng l·∫°i
                    break;
                }
            }
            return { decodedCode: currentCode, iterations };
        }

        /**
         * H√†m ch√≠nh ƒëi·ªÅu khi·ªÉn to√†n b·ªô qu√° tr√¨nh.
         */
        function processDecode() {
            const sourceCode = inputEl.value.trim();
            if (!sourceCode) {
                logEl.textContent = "Vui l√≤ng nh·∫≠p m√£ ƒë·ªÉ gi·∫£i.";
                return;
            }

            logEl.textContent = "ƒêang gi·∫£i m√£... Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y.";
            
            setTimeout(() => {
                try {
                    // B∆∞·ªõc 1: Gi·∫£i m√£ li√™n t·ª•c
                    const { decodedCode, iterations } = unpackContinuously(sourceCode);
                    
                    // B∆∞·ªõc 2: L√†m ƒë·∫πp m√£ k·∫øt qu·∫£
                    const beautifiedCode = js_beautify(decodedCode, {
                        indent_size: 2,
                        space_in_empty_paren: true,
                        max_preserve_newlines: 2
                    });

                    // B∆∞·ªõc 3: Hi·ªÉn th·ªã v√† t√¥ m√†u c√∫ ph√°p
                    outputEl.textContent = beautifiedCode;
                    hljs.highlightElement(outputEl);
                    
                    if (iterations > 0) {
                        logEl.textContent = `Ho√†n t·∫•t! ƒê√£ th·ª±c hi·ªán ${iterations} l∆∞·ª£t gi·∫£i m√£.`;
                    } else {
                         logEl.textContent = "Ho√†n t·∫•t! M√£ kh√¥ng c√≥ v·∫ª b·ªã 'packed' ho·∫∑c ƒë√£ s·∫°ch.";
                    }

                } catch (error) {
                    outputEl.textContent = `L·ªói trong qu√° tr√¨nh gi·∫£i m√£ ho·∫∑c l√†m ƒë·∫πp m√£:\n${error.message}`;
                    logEl.textContent = "ƒê√£ x·∫£y ra l·ªói.";
                }
            }, 50);
        }

        function copyResult() {
            const textToCopy = outputEl.textContent;
            if (!textToCopy || textToCopy.includes("s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y")) {
                logEl.textContent = "Kh√¥ng c√≥ g√¨ ƒë·ªÉ sao ch√©p.";
                return;
            }
            navigator.clipboard.writeText(textToCopy).then(() => {
                logEl.textContent = "ƒê√£ sao ch√©p k·∫øt qu·∫£ v√†o clipboard!";
            }).catch(err => {
                logEl.textContent = "L·ªói khi sao ch√©p: " + err;
            });
        }

        function clearInputs() {
            inputEl.value = '';
            outputEl.textContent = 'K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...';
            logEl.textContent = '';
            hljs.highlightElement(outputEl);
        }
        
        // G√°n s·ª± ki·ªán cho c√°c n√∫t
        decodeBtn.addEventListener('click', processDecode);
        copyBtn.addEventListener('click', copyResult);
        clearBtn.addEventListener('click', clearInputs);

        // T·ª± ƒë·ªông gi·∫£i m√£ khi ng∆∞·ªùi d√πng d√°n n·ªôi dung v√†o
        inputEl.addEventListener('paste', () => {
            setTimeout(processDecode, 100);
        });
    </script>
</body>
</html>
