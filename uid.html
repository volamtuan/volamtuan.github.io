<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm tra UID Facebook</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #loading {
            display: none;
            text-align: center;
            font-size: 1.5rem;
        }
        .progress {
            height: 25px;
        }
        .box {
            margin-top: 20px;
        }
        .toast {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            background-color: #28a745;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        .toast-error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>

<div class="text-container mt-5">
    <h3>Ki·ªÉm tra UID Facebook</h3>

    <div>
        <label for="uidInput">Nh·∫≠p UID (1 UID m·ªói d√≤ng):</label>
        <textarea id="uidInput" class="form-control" rows="5" placeholder="Nh·∫≠p UID v√†o ƒë√¢y..."></textarea>
        <br>
        <input type="file" id="fileInput" class="form-control">
        <button id="clearBtn" class="btn btn-outline-danger mt-2" style="display:none;" onclick="clearAll()">X√≥a t·∫•t c·∫£</button>
    </div>

    <p id="loading">‚è≥ ƒêang x·ª≠ l√Ω...</p>
    <div class="progress mb-3">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
    </div>

    <div class="box">
        <h5>‚úÖ UID S·ªëng (<span id="countLive">0</span>)</h5>
        <textarea id="ListLive" class="form-control" rows="5" readonly></textarea>
        <button class="btn btn-outline-success mt-2" onclick="copyToClipboard('ListLive')">üìã Copy</button>
    </div>

    <div class="box">
        <h5>‚ùå UID Ch·∫øt (<span id="countDead">0</span>)</h5>
        <textarea id="ListDead" class="form-control" rows="5" readonly></textarea>
        <button class="btn btn-outline-danger mt-2" onclick="copyToClipboard('ListDead')">üìã Copy</button>
    </div>

    <div class="box">
        <h5>L·ªçc UID theo t·ª´ kh√≥a</h5>
        <textarea id="map_have_text" class="form-control" rows="3" placeholder="Nh·∫≠p t·ª´ kh√≥a c·∫ßn ch·ª©a..."></textarea>
        <textarea id="map_havenot_text" class="form-control" rows="3" placeholder="Nh·∫≠p t·ª´ kh√≥a kh√¥ng ch·ª©a..."></textarea>
        <button class="btn btn-outline-primary mt-2" onclick="mapText()">L·ªçc</button>
    </div>

    <div class="box">
        <h5>K·∫øt qu·∫£ l·ªçc</h5>
        <textarea id="filteredOutput" class="form-control" rows="5" readonly></textarea>
        <button class="btn btn-outline-info mt-2" onclick="copyToClipboard('filteredOutput')">üìã Copy</button>
    </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast" style="display: none;">ƒê√£ sao ch√©p v√†o clipboard!</div>

<script>
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('uidInput').value += '\n' + e.target.result;
            toggleClearButton();
            checkUIDs();
        };
        reader.readAsText(file);
    });

    function toggleClearButton() {
        const input = document.getElementById("uidInput").value.trim();
        document.getElementById("clearBtn").style.display = input ? "inline-block" : "none";
    }

    function clearAll() {
        ['uidInput', 'ListLive', 'ListDead', 'filteredOutput'].forEach(id => document.getElementById(id).value = "");
        ['countLive', 'countDead'].forEach(id => document.getElementById(id).textContent = "0");
        updateProgress(0);
        toggleClearButton();
    }

    function updateProgress(val) {
        let bar = document.getElementById("progressBar");
        bar.style.width = val + "%";
        bar.textContent = Math.round(val) + "%";
    }

    async function checkUIDs() {
        let raw = document.getElementById("uidInput").value.split("\n").map(e => e.trim()).filter(e => e);
        let lines = [...new Set(raw)];
        let batchSize = 1000; // Ch·ªânh s·ªë l∆∞·ª£ng UID x·ª≠ l√Ω c√πng m·ªôt l√∫c
        let live = [],
            dead = [],
            total = lines.length;
        let liveCount = 0,
            deadCount = 0;

        document.getElementById("loading").style.display = "block";

        for (let i = 0; i < total; i += batchSize) {
            let batch = lines.slice(i, i + batchSize);
            // ƒê∆∞a v√†o queue ƒë·ªÉ x·ª≠ l√Ω kh√¥ng ƒë·ªìng b·ªô
            await processBatch(batch, live, dead, total, i, liveCount, deadCount);
        }

        document.getElementById("loading").style.display = "none";
    }

    async function processBatch(batch, live, dead, total, startIndex, liveCount, deadCount) {
        for (let line of batch) {
            let parts = line.split('|');
            let uid = parts[0];

            if (live.includes(uid) || dead.includes(uid)) return;

            try {
                // G·ª≠i y√™u c·∫ßu ki·ªÉm tra UID qua Facebook API
                let res = await fetch(`https://graph.facebook.com/${uid}/picture?type=normal`);
                if (res.ok && !res.url.includes("/static")) {
                    document.getElementById('ListLive').value += line + "\n";
                    document.getElementById('countLive').textContent = ++liveCount;
                    live.push(uid);
                } else {
                    document.getElementById('ListDead').value += line + "\n";
                    document.getElementById('countDead').textContent = ++deadCount;
                    dead.push(uid);
                }
            } catch (error) {
                console.error(`L·ªói ki·ªÉm tra UID ${uid}:`, error);
                document.getElementById('ListDead').value += line + " (L·ªói k·∫øt n·ªëi)\n";
                document.getElementById('countDead').textContent = ++deadCount;
                dead.push(uid);
                showToast('L·ªói k·∫øt n·ªëi');
            }

            updateProgress(((startIndex + batch.indexOf(line)) / total) * 100);
        }
    }

    function copyToClipboard(id) {
        let textarea = document.getElementById(id);
        textarea.select();
        document.execCommand("copy");
        showToast('ƒê√£ sao ch√©p v√†o clipboard!');
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }

    function mapText() {
        const input = document.getElementById("uidInput").value.split("\n").map(e => e.trim()).filter(e => e);
        const includeWords = document.getElementById("map_have_text").value.split("\n").map(e => e.trim().toLowerCase()).filter(e => e);
        const excludeWords = document.getElementById("map_havenot_text").value.split("\n").map(e => e.trim().toLowerCase()).filter(e => e);

        let filtered = input.filter(line => {
            const lower = line.toLowerCase();
            const hasAny = includeWords.length ? includeWords.some(w => lower.includes(w)) : true;
            const hasNone = excludeWords.every(w => !lower.includes(w));
            return hasAny && hasNone;
        });

        filtered = [...new Set(filtered)];
        document.getElementById("filteredOutput").value = filtered.join("\n");
    }
</script>

</body>
</html>
