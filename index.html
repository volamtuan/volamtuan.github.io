<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>GitHub File Manager</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { background:#f9f9f9; font-family: monospace; }
header { background:#212529; color:white; padding:10px; text-align:center; font-size:1.2em; }
#loginBox, #fileManager { max-width:900px; margin:20px auto; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:20px; }
#fileList td { vertical-align: middle; }
.folder { color:#007bff; }
.file { color:#495057; }
.notice { margin-top:10px; }
</style>
</head>
<body>

<header>📁 GitHub File Manager</header>

<div id="loginBox">
  <h5>🔐 Kết nối đến Repository</h5>
  <div class="mb-2">
    <label>👤 Username</label>
    <input id="user" class="form-control" placeholder="vd: volamtuan">
  </div>
  <div class="mb-2">
    <label>📦 Repository</label>
    <input id="repo" class="form-control" placeholder="vd: volamtuan.github.io">
  </div>
  <div class="mb-2">
    <label>🔑 GitHub Token</label>
    <input id="token" class="form-control" placeholder="Personal Access Token (PAT)">
  </div>
  <button class="btn btn-primary w-100" id="connectBtn">Kết nối Repository</button>
</div>

<div id="fileManager" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5>📂 <span id="currentPath">/</span></h5>
    <div>
      <button class="btn btn-success btn-sm" id="newFolderBtn"><i class="bi bi-folder-plus"></i> Tạo thư mục</button>
      <button class="btn btn-primary btn-sm" id="newFileBtn"><i class="bi bi-file-earmark-plus"></i> Tạo file</button>
      <button class="btn btn-danger btn-sm" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Đăng xuất</button>
    </div>
  </div>
  <table class="table table-hover" id="fileList">
    <thead><tr><th>Tên</th><th>Kích thước</th><th>Hành động</th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="notice" id="status"></div>
</div>

<script>
const apiBase = "https://api.github.com";
let user, repo, token, path = "";

function saveConfig() {
  localStorage.setItem("gh_user", user);
  localStorage.setItem("gh_repo", repo);
  localStorage.setItem("gh_token", token);
}
function loadConfig() {
  user = localStorage.getItem("gh_user");
  repo = localStorage.getItem("gh_repo");
  token = localStorage.getItem("gh_token");
  return user && repo && token;
}

async function github(method, endpoint, body=null) {
  const res = await fetch(`${apiBase}${endpoint}`, {
    method,
    headers: {
      "Authorization": "token " + token,
      "Accept": "application/vnd.github+json"
    },
    body: body ? JSON.stringify(body) : null
  });
  if (!res.ok) throw new Error(res.status + " " + res.statusText);
  return await res.json();
}

async function listFiles() {
  document.getElementById("status").innerText = "🔄 Đang tải...";
  try {
    const files = await github("GET", `/repos/${user}/${repo}/contents/${path}`);
    const tbody = document.querySelector("#fileList tbody");
    tbody.innerHTML = "";
    files.forEach(f=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><i class="bi ${f.type==="dir"?"bi-folder-fill folder":"bi-file-earmark file"}"></i> 
          <a href="#" onclick="openPath('${f.path}')">${f.name}</a></td>
        <td>${f.size || "-"}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteItem('${f.path}','${f.sha}')"><i class="bi bi-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("status").innerText = "✅ Hoàn tất!";
  } catch(e){
    document.getElementById("status").innerText = "❌ Lỗi: " + e.message;
  }
}

async function openPath(newPath) {
  path = newPath;
  document.getElementById("currentPath").innerText = "/" + path;
  await listFiles();
}

async function deleteItem(p, sha) {
  if (!confirm("Xoá " + p + " ?")) return;
  try {
    await github("DELETE", `/repos/${user}/${repo}/contents/${p}`, { message: "delete "+p, sha });
    document.getElementById("status").innerText = "🗑️ Đã xoá " + p;
    await listFiles();
  } catch(e){ document.getElementById("status").innerText = "❌ Lỗi xoá: " + e.message; }
}

async function createItem(type) {
  const name = prompt(`Nhập tên ${type==='dir'?'thư mục':'file'}`);
  if (!name) return;
  try {
    if (type === "dir") {
      await github("PUT", `/repos/${user}/${repo}/contents/${path}/${name}/.keep`, {
        message: "create folder " + name,
        content: btoa("")
      });
    } else {
      await github("PUT", `/repos/${user}/${repo}/contents/${path}/${name}`, {
        message: "create file " + name,
        content: btoa("")
      });
    }
    document.getElementById("status").innerText = "✅ Đã tạo " + name;
    await listFiles();
  } catch(e){ document.getElementById("status").innerText = "❌ Lỗi tạo: " + e.message; }
}

document.getElementById("connectBtn").onclick = async ()=>{
  user=document.getElementById("user").value.trim();
  repo=document.getElementById("repo").value.trim();
  token=document.getElementById("token").value.trim();
  if(!user||!repo||!token)return alert("Vui lòng nhập đầy đủ!");
  saveConfig();
  document.getElementById("loginBox").style.display="none";
  document.getElementById("fileManager").style.display="block";
  await listFiles();
};

document.getElementById("newFolderBtn").onclick=()=>createItem("dir");
document.getElementById("newFileBtn").onclick=()=>createItem("file");
document.getElementById("logoutBtn").onclick=()=>{
  localStorage.clear();
  location.reload();
};

if(loadConfig()){
  document.getElementById("loginBox").style.display="none";
  document.getElementById("fileManager").style.display="block";
  listFiles();
}
</script>

</body>
</html>
