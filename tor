#!/bin/bash

# Hàm log
function log() {
   echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") [install] $1"
}

# Kiểm tra hệ điều hành và trình quản lý gói (Ubuntu/Debian vs CentOS/RHEL)
if [ -f /etc/lsb-release ] || [ -f /etc/debian_version ]; then
    OS="ubuntu"
    PKG_MGR="apt"
    UFW="ufw"
elif [ -f /etc/redhat-release ]; then
    OS="centos"
    PKG_MGR="yum"
    UFW="firewalld"
else
    log "Unsupported operating system."
    exit 1
fi

log "Detected operating system: $OS"

# Cập nhật và cài đặt các gói cần thiết
log "Installing Tor..."
if [ "$OS" == "ubuntu" ]; then
    sudo apt update && sudo apt install tor ufw curl net-tools -y
elif [ "$OS" == "centos" ]; then
    sudo yum install epel-release -y
    sudo yum install tor firewalld curl net-tools -y
    sudo systemctl start firewalld
    sudo systemctl enable firewalld
fi

# Cấu hình firewall mở các cổng cần thiết
log "Configuring firewall..."
if [ "$OS" == "ubuntu" ]; then
    sudo ufw allow 9050/tcp
    sudo ufw allow 3128/tcp
    sudo ufw allow 10000:11000/tcp
    sudo ufw allow 20000:21000/tcp
    sudo ufw allow 30000:31000/tcp
    sudo ufw allow 40000:41000/tcp
    sudo ufw allow 50000:51000/tcp
    sudo ufw reload
elif [ "$OS" == "centos" ]; then
    sudo firewall-cmd --permanent --add-port=9050/tcp
    sudo firewall-cmd --permanent --add-port=3128/tcp
    sudo firewall-cmd --permanent --add-port=10000-11000/tcp
    sudo firewall-cmd --permanent --add-port=20000-21000/tcp
    sudo firewall-cmd --permanent --add-port=30000-31000/tcp
    sudo firewall-cmd --permanent --add-port=40000-41000/tcp
    sudo firewall-cmd --permanent --add-port=50000-51000/tcp
    sudo firewall-cmd --reload
fi

# Cài đặt cấu hình cho Tor
log "Downloading new Tor configuration..."
sudo rm -f /etc/tor/torrc
sudo curl -o /etc/tor/torrc https://volamtuan.github.io/torrc

# Khởi động lại dịch vụ Tor
log "Restarting Tor service..."
sudo systemctl restart tor
sudo systemctl enable tor
ỏ

log "Installation and configuration completed successfully!"

# Kiểm tra trạng thái của các cổng đang mở
log "Displaying open ports..."
netstat -tuln

# Tạo tệp checkip.txt để lưu kết quả kiểm tra proxy
# Kiểm tra một số proxy qua các cổng mẫu
log "Kiểm tra kết nối qua các proxy mẫu..."
curl --proxy socks5h://localhost:10000 http://ipecho.net/plain
curl --proxy socks5h://localhost:20000 http://ipecho.net/plain
curl --proxy socks5h://localhost:30000 http://ipecho.net/plain
curl --proxy socks5h://localhost:40000 http://ipecho.net/plain
curl --proxy socks5h://localhost:50000 http://ipecho.net/plain

