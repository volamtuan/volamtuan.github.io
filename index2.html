<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lọc Dữ Liệu Nâng Cao</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js"></script>
  <style>
    body { background: #f1f1f1; padding: 20px; font-family: sans-serif; }
    textarea { font-family: monospace; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
    
    /* === CSS cho Toast Notification === */
    #toast {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 16px;
      position: fixed;
      z-index: 10;
      left: 50%;
      bottom: 30px;
      font-size: 17px;
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>

<!-- Thêm thẻ div cho toast vào cuối body -->
<div id="toast"></div>

<div class="text-container">
  <h1 class="text-center">Công cụ Xử lý Text</h1>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="cut-tab" data-toggle="tab" href="#cut" role="tab">Cắt Chuỗi</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="remove-duplicates-tab" data-toggle="tab" href="#remove-duplicates" role="tab">Lọc Trùng</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="merge-tab" data-toggle="tab" href="#merge" role="tab">Ghép File</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="filter-tab" data-toggle="tab" href="#filter" role="tab">Lọc Chuỗi Text</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="totp-tab" data-toggle="tab" href="#totp" role="tab">Lấy Mã 2FA</a>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <!-- Tab Cắt Chuỗi -->
    <div class="tab-pane fade show active" id="cut" role="tabpanel">
      <form>
        <div class="form-group">
          <textarea id="cutInput" rows="5" class="form-control" placeholder="Nhập nội dung cần cắt..."></textarea>
        </div>
        <div class="form-group">
          <label>Ngăn cách bởi ký tự</label>
          <input type="text" id="delimiter" class="form-control" value="|" />
        </div>
        <div class="form-group">
          <label>Dòng không cần cắt (số dòng)</label>
          <input type="number" id="excludeLines" class="form-control" value="0" />
        </div>
        <div class="form-group">
          <label>Bắt đầu từ vị trí</label>
          <input type="number" id="start" class="form-control" value="1" />
        </div>
        <div class="form-group">
          <label>Kết thúc ở vị trí</label>
          <input type="number" id="end" class="form-control" value="1" />
        </div>
        <button type="button" onclick="cutString()" class="btn btn-warning">Cắt chuỗi</button>
        <div class="result mt-3">
          <label>Kết quả (tự động sao chép)</label>
          <textarea id="cutResult" class="form-control" rows="5" readonly></textarea>
        </div>
      </form>
    </div>

    <!-- Tab Lọc Trùng -->
    <div class="tab-pane fade" id="remove-duplicates" role="tabpanel">
      <form>
        <div class="form-group">
          <textarea id="filterInput" rows="5" class="form-control" placeholder="Nhập nội dung cần lọc trùng..."></textarea>
        </div>
        <button type="button" onclick="removeDuplicates()" class="btn btn-warning">Lọc trùng</button>
        <div class="result mt-3">
          <label>Kết quả (tự động sao chép)</label>
          <textarea id="filterResult" class="form-control" rows="5" readonly></textarea>
        </div>
      </form>
    </div>

    <!-- Tab Ghép File -->
    <div class="tab-pane fade" id="merge" role="tabpanel">
      <form>
        <div class="form-group">
          <label>Nội dung 1</label>
          <textarea id="mergeInput1" rows="5" class="form-control"></textarea>
        </div>
        <div class="form-group">
          <label>Nội dung 2</label>
          <textarea id="mergeInput2" rows="5" class="form-control"></textarea>
        </div>
        <div class="form-group">
          <label>Ngăn cách giữa 2 dòng</label>
          <input type="text" id="mergeDelimiter" class="form-control" />
        </div>
        <button type="button" onclick="mergeFiles()" class="btn btn-warning">Ghép file</button>
        <div class="result mt-3">
          <label>Kết quả (tự động sao chép)</label>
          <textarea id="mergeResult" class="form-control" rows="5" readonly></textarea>
        </div>
      </form>
    </div>

    <!-- Tab Lọc Chuỗi -->
    <div class="tab-pane fade" id="filter" role="tabpanel">
      <form>
        <div class="form-group">
          <textarea id="inputText" rows="5" class="form-control" placeholder="Nhập nội dung cần lọc.."></textarea>
        </div>
        <div class="form-group">
          <label>Nhập từ để lọc (ngăn cách bằng dấu phẩy)</label>
          <textarea id="filterWords" rows="5" class="form-control"></textarea>
        </div>
        <button class="btn btn-success mt-2" type="button" onclick="filterContains()">Lọc chứa từ</button>
        <button class="btn btn-danger mt-2" type="button" onclick="filterNotContains()">Lọc không chứa từ</button>
        <div class="result mt-3">
          <label>Kết quả (tự động sao chép)</label>
          <textarea id="outputText" rows="5" class="form-control" readonly></textarea>
        </div>
      </form>
    </div>

    <!-- Tab TOTP -->
    <div class="tab-pane fade" id="totp" role="tabpanel">
      <form>
        <div class="form-group">
          <label>Nhập hoặc dán Key 2FA</label>
          <textarea id="secret-key" rows="5" class="form-control"></textarea>
        </div>
        <div class="totp-section">
          <p><strong id="auth-code" onclick="navigator.clipboard.writeText(this.innerText)"> </strong></p>
          <span class="countdown" id="countdown"></span>
          <button type="button" onclick="clearInput()" class="btn btn-danger">Xóa</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
// ✅ Hàm hiển thị thông báo (toast)
function showToast(message = "Đã tự động sao chép kết quả!") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "show";
  setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

// ✅ Hàm sao chép văn bản một cách tự động và hiện thông báo
function autoCopyToClipboard(text) {
  if (!text) return; // Không làm gì nếu không có nội dung
  navigator.clipboard.writeText(text).then(() => {
    showToast(); // Hiển thị thông báo khi thành công
  }).catch(err => {
    console.error('Lỗi sao chép: ', err);
    showToast("Lỗi: Không thể sao chép!"); // Báo lỗi nếu thất bại
  });
}

// Các hàm xử lý đã được cập nhật
function cutString() {
  const inputText = document.getElementById("cutInput").value.trim();
  const delimiter = document.getElementById("delimiter").value;
  const start = parseInt(document.getElementById("start").value) - 1;
  const end = parseInt(document.getElementById("end").value) - 1;
  const excludeLines = parseInt(document.getElementById("excludeLines").value);
  const lines = inputText.split("\n");
  const result = [];

  lines.forEach((line, idx) => {
    if (idx + 1 !== excludeLines) {
      const parts = line.split(delimiter);
      if (parts.length > end) {
        result.push(parts.slice(start, end + 1).join(delimiter));
      }
    }
  });

  const resultText = result.join("\n");
  document.getElementById("cutResult").value = resultText;
  autoCopyToClipboard(resultText); // TỰ ĐỘNG SAO CHÉP
}

function removeDuplicates() {
  const input = document.getElementById("filterInput").value.trim().split("\n");
  const unique = [...new Set(input)];
  const resultText = unique.join("\n");
  document.getElementById("filterResult").value = resultText;
  autoCopyToClipboard(resultText); // TỰ ĐỘNG SAO CHÉP
}

function mergeFiles() {
  const input1 = document.getElementById("mergeInput1").value.trim().split("\n");
  const input2 = document.getElementById("mergeInput2").value.trim().split("\n");
  const delimiter = document.getElementById("mergeDelimiter").value;
  const result = [];

  const max = Math.max(input1.length, input2.length);
  for (let i = 0; i < max; i++) {
    result.push((input1[i] || "") + delimiter + (input2[i] || ""));
  }

  const resultText = result.join("\n");
  document.getElementById("mergeResult").value = resultText;
  autoCopyToClipboard(resultText); // TỰ ĐỘNG SAO CHÉP
}

function filterContains() {
  const input = document.getElementById("inputText").value.split("\n");
  const keywords = document.getElementById("filterWords").value.toLowerCase().split(",").map(s => s.trim());
  const filtered = input.filter(line => keywords.some(k => k && line.toLowerCase().includes(k)));
  const resultText = filtered.join("\n");
  document.getElementById("outputText").value = resultText;
  autoCopyToClipboard(resultText); // TỰ ĐỘNG SAO CHÉP
}

function filterNotContains() {
  const input = document.getElementById("inputText").value.split("\n");
  const keywords = document.getElementById("filterWords").value.toLowerCase().split(",").map(s => s.trim());
  const filtered = input.filter(line => !keywords.some(k => k && line.toLowerCase().includes(k)));
  const resultText = filtered.join("\n");
  document.getElementById("outputText").value = resultText;
  autoCopyToClipboard(resultText); // TỰ ĐỘNG SAO CHÉP
}

// --- Các hàm cho 2FA (giữ nguyên và cải tiến) ---

function clearInput() {
  document.getElementById("secret-key").value = "";
  document.getElementById("auth-code").textContent = "";
  document.getElementById("countdown").textContent = "";
  document.getElementById("countdown").style.display = "none";
}

function base32tohex(base32) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  let bits = "", hex = "";
  for (let c of base32.toUpperCase()) {
    const val = chars.indexOf(c);
    if (val >= 0) bits += val.toString(2).padStart(5, '0');
  }
  for (let i = 0; i + 8 <= bits.length; i += 8) {
    hex += parseInt(bits.substr(i, 8), 2).toString(16).padStart(2, '0');
  }
  return hex;
}

function generateTOTP(secret) {
  try {
    const epoch = Math.floor(Date.now() / 1000);
    const time = Math.floor(epoch / 30).toString(16).padStart(16, '0');
    const key = base32tohex(secret);
    if (!key) return null; // Thêm kiểm tra key hợp lệ
    const shaObj = new jsSHA("SHA-1", "HEX");
    shaObj.setHMACKey(key, "HEX");
    shaObj.update(time);
    const hmac = shaObj.getHMAC("HEX");
    const offset = parseInt(hmac.substring(hmac.length - 1), 16);
    const binary = parseInt(hmac.substr(offset * 2, 8), 16) & 0x7fffffff;
    return (binary % 1000000).toString().padStart(6, '0');
  } catch (e) {
    return null;
  }
}

let lastGeneratedCode = '';

function updateCode() {
  const secret = document.getElementById('secret-key').value.trim().replace(/\s+/g, '');
  const codeEl = document.getElementById('auth-code');
  const countdown = document.getElementById('countdown');

  if (!secret) {
    codeEl.textContent = '';
    countdown.style.display = 'none';
    return;
  }

  const code = generateTOTP(secret);
  if (code) {
    codeEl.textContent = code.slice(0, 3) + ' ' + code.slice(3); // Thêm khoảng trắng cho dễ đọc
    countdown.style.display = 'block';
    // Chỉ sao chép và hiển thị thông báo nếu mã mới được tạo khác với mã cũ
    if (code !== lastGeneratedCode) {
      navigator.clipboard.writeText(code).catch(() => {});
      showToast('Mã 2FA mới đã được sao chép!');
      lastGeneratedCode = code;
    }
  } else {
    codeEl.textContent = 'Key không hợp lệ';
    countdown.style.display = 'none';
    lastGeneratedCode = '';
  }
}

function updateCountdown() {
  const countdown = document.getElementById('countdown');
  const secret = document.getElementById('secret-key').value.trim().replace(/\s+/g, '');
  if (!secret) {
    countdown.style.display = 'none';
    return;
  }
  const epoch = Math.floor(Date.now() / 1000);
  countdown.textContent = `Thời gian còn lại: ${30 - (epoch % 30)}s`;
}

document.getElementById('secret-key').addEventListener('input', () => {
    lastGeneratedCode = ''; // Reset mã đã lưu khi người dùng thay đổi key
    updateCode();
    updateCountdown();
});

setInterval(() => {
  if (document.getElementById('secret-key').value.trim()) {
    const seconds = new Date().getSeconds();
    if (seconds % 30 === 0) { // Chỉ gọi updateCode khi chu kỳ 30s bắt đầu
        updateCode();
    }
    updateCountdown();
  }
}, 1000);
</script>
</body>
</html>
