#!/bin/bash

NUM_CONTAINERS=200
PORT_8118_START=8000
PORT_4444_START=4444

create_container() {
  local i=$1
  local CONTAINER_NAME="tor-proxy${i}"
  local PORT_8118=$((PORT_8118_START + i))
  local PORT_4444=$((PORT_4444_START + i))

  docker run --restart=always -d \
    --name "$CONTAINER_NAME" \
    -p "$PORT_8118:8118" -p "$PORT_4444:4444" \
    -e "TOR_COUNTRY=US,CA,LU,DE" \
    -e "TOR_INSTANCES=5" \
    -e "TOR_REBUILD_INTERVAL=3600" \
    vltpro/tor-privoxy

  if [ $? -eq 0 ]; then
    echo "Đã tạo container $CONTAINER_NAME với các cổng: $PORT_8118, $PORT_4444"
  else
    echo "Lỗi tạo container $CONTAINER_NAME"
    exit 1
  fi
}

for i in $(seq 1 $NUM_CONTAINERS); do
  create_container $i
  sleep 1 # Thời gian chờ 1 giây giữa các lần tạo container
done

TEST_URL="http://httpbin.org/ip"
IP_INFO_API="https://ipinfo.io"  # Dịch vụ để lấy thông tin quốc gia
LOG_FILE="proxy_check.log"

# Tạo hoặc xóa log cũ
echo "Bắt đầu kiểm tra proxy..." > $LOG_FILE

# Lấy danh sách cổng đang mở và kiểm tra tất cả các cổng lắng nghe
OPEN_PORTS=$(netstat -tuln | grep LISTEN | awk '{print $4}' | grep -oE '[0-9]+$' | sort -u)

if [[ -z "$OPEN_PORTS" ]]; then
    echo "Không tìm thấy cổng nào đang mở."
    echo "Không tìm thấy cổng nào đang mở." >> $LOG_FILE
    exit 1
fi

echo "Danh sách cổng đang mở: $OPEN_PORTS"
echo "Danh sách cổng đang mở: $OPEN_PORTS" >> $LOG_FILE
echo "Bắt đầu kiểm tra các proxy..." >> $LOG_FILE

# Duyệt qua từng cổng trong danh sách mở
for PORT in $OPEN_PORTS; do
    echo -n "Đang kiểm tra cổng $PORT... "
    echo -n "Đang kiểm tra cổng $PORT... " >> $LOG_FILE

    # Kiểm tra proxy với cổng đã chọn
    OUTPUT=$(curl -s -x "http://localhost:$PORT" $TEST_URL | jq -r '.origin' 2>/dev/null)

    if [[ $? -eq 0 && -n "$OUTPUT" ]]; then
        # Lấy thông tin quốc gia từ IP của proxy
        COUNTRY=$(curl -s "$IP_INFO_API/$OUTPUT" | jq -r '.country' 2>/dev/null)

        if [[ -z "$COUNTRY" || "$COUNTRY" == "null" ]]; then
            COUNTRY="Không xác định"
        fi

        echo "OK - IP: $OUTPUT, Quốc gia: $COUNTRY"
        echo "OK - IP: $OUTPUT, Quốc gia: $COUNTRY" >> $LOG_FILE
    else
        echo "Không hoạt động"
        echo "Không hoạt động" >> $LOG_FILE
    fi
done

echo "Hoàn tất kiểm tra."
echo "Hoàn tất kiểm tra." >> $LOG_FILE
